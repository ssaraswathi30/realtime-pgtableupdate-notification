<!DOCTYPE html>
<html>
<head>
  <title>Socket.IO Connection Test</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px;
      background-color: #f8f9fa;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .status {
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    .connected { background-color: #d4edda; color: #155724; }
    .disconnected { background-color: #f8d7da; color: #721c24; }
    .error { background-color: #fff3cd; color: #856404; }
    .log-entry {
      background: white;
      padding: 10px;
      margin: 5px 0;
      border-left: 4px solid #007bff;
      border-radius: 4px;
    }
    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    .btn:hover { background: #0056b3; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #c82333; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Socket.IO Connection Test</h1>
    
    <div id="connection-status" class="status disconnected">
      Disconnected
    </div>
    
    <div class="controls">
      <h3>Test Controls</h3>
      <button class="btn" onclick="testConnection()">Test Connection</button>
      <button class="btn" onclick="insertTestLog()">Insert Test Log</button>
      <button class="btn" onclick="checkHealth()">Check Health</button>
      <button class="btn btn-danger" onclick="disconnect()">Disconnect</button>
    </div>
    
    <div class="logs">
      <h3>Real-time Logs</h3>
      <div id="logs-container"></div>
    </div>
    
    <div class="debug">
      <h3>Debug Info</h3>
      <div id="debug-info"></div>
    </div>
  </div>

  <script>
    let socket = null;
    const statusEl = document.getElementById('connection-status');
    const logsContainer = document.getElementById('logs-container');
    const debugInfo = document.getElementById('debug-info');
    
    function updateStatus(message, className) {
      statusEl.textContent = message;
      statusEl.className = `status ${className}`;
    }
    
    function addDebugMessage(message) {
      const div = document.createElement('div');
      div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
      debugInfo.appendChild(div);
      debugInfo.scrollTop = debugInfo.scrollHeight;
    }
    
    function addLogEntry(data) {
      const div = document.createElement('div');
      div.className = 'log-entry';
      div.innerHTML = `
        <strong>#${data.id}</strong> [${data.log_level}] 
        ${data.message} 
        <small>(${data.source || 'Unknown'})</small>
        <small style="float: right;">${new Date(data.created_at).toLocaleTimeString()}</small>
      `;
      logsContainer.insertBefore(div, logsContainer.firstChild);
    }
    
    function testConnection() {
      if (socket && socket.connected) {
        addDebugMessage('Already connected!');
        return;
      }
      
      addDebugMessage('Attempting to connect to Socket.IO server...');
      
      socket = io('http://localhost:8080', {
        transports: ['websocket', 'polling'],
        timeout: 5000
      });
      
      socket.on('connect', () => {
        updateStatus(`Connected (ID: ${socket.id})`, 'connected');
        addDebugMessage(`✅ Connected with ID: ${socket.id}`);
        socket.emit('subscribe-logs', { client: 'test-dashboard' });
      });
      
      socket.on('welcome', (data) => {
        addDebugMessage(`👋 Welcome: ${data.message}`);
      });
      
      socket.on('log-update', (data) => {
        addDebugMessage(`📨 Log update received: ${JSON.stringify(data)}`);
        addLogEntry(data);
      });
      
      socket.on('disconnect', (reason) => {
        updateStatus(`Disconnected (${reason})`, 'disconnected');
        addDebugMessage(`❌ Disconnected: ${reason}`);
      });
      
      socket.on('connect_error', (error) => {
        updateStatus(`Connection Error: ${error.message}`, 'error');
        addDebugMessage(`❌ Connection error: ${error.message}`);
      });
    }
    
    function disconnect() {
      if (socket) {
        socket.disconnect();
        addDebugMessage('🔌 Manually disconnected');
      }
    }
    
    async function insertTestLog() {
      try {
        const response = await fetch('http://localhost:8080/api/logs', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            log_level: 'INFO',
            message: 'Test log from dashboard',
            source: 'test-dashboard'
          })
        });
        
        const result = await response.json();
        addDebugMessage(`📝 Inserted log: ${JSON.stringify(result)}`);
      } catch (error) {
        addDebugMessage(`❌ Error inserting log: ${error.message}`);
      }
    }
    
    async function checkHealth() {
      try {
        const response = await fetch('http://localhost:8080/api/health');
        const result = await response.json();
        addDebugMessage(`💚 Health check: ${JSON.stringify(result)}`);
      } catch (error) {
        addDebugMessage(`❌ Error checking health: ${error.message}`);
      }
    }
    
    // Auto-connect on page load
    window.addEventListener('load', () => {
      addDebugMessage('Page loaded, auto-connecting...');
      testConnection();
    });
  </script>
</body>
</html>
